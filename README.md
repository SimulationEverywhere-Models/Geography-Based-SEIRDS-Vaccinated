Cell-DEVS Geographical SEIRDS-Vaccinated Pandemic Model
===
Overview
----
This model is an extension of a previous [SEIRDS model](https://github.com/SimulationEverywhere-Models/Geography-Based-SEIRDS)

The inital model was based on the [Zhong model](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7088542/pdf/11430_2009_Article_44.pdf)

<!-- Documentation
----
See the `Manual.docx` file located at the root of this repository, `Geographical SEIRDS COVID-19 Model.pdf`, and the README files in folders -->

Requirements
---
* A C++17 compiler (GCC was used for development)
* A copy of this repository
* A copy of Cadmium ([master](https://github.com/SimulationEverywhere/cadmium))
* Python 3, Python packages geopandas, numpy, matplotlib
* Java Runtime Environment
* Make

The following commands can be used to get cadmium:
~~~
 git clone https://github.com/SimulationEverywhere/cadmium.git
 cd cadmium
 git submodule update --init --recursive
~~~

The dependencies for cadmium must also be installed. Refer to this [document](http://www.sce.carleton.ca/courses/sysc-5104/lib/exe/fetch.php?media=cadmium.pdf).

The location of cadmium must be in the parent folder that holds this project, or the directory directly above.

If the location of this cloned repository has the location of `parentFolder/GeographicalModel`, then the cadmium library should be located in parentFolder.

Alternatively if the location of this cloned repository has the location of `parentFolder/projectsFolder/GeographicalModel`, then the cadmium library should be located in parentFolder.

Running a Simulation
----
This project contains a number of utilities that can work in sequence. The script `run_simulation.sh`, compiles the model, generates a scenario from data, runs the model, and processes the output, and can be modified as needed to run scenarios automatically.
The .sh scripts does:

1. Compiles the model if it isn't already or it can be set to rebuild (use `--flags` to see all the options)
2. Generates a cell space from geographical data, initializes infection in a single cell.
3. Runs a simulation with the generated scenario
4. Generates SEIRD graphs of the simulation (saved in logs folder)
5. Converts the message log of the simulation into standard web viewer format (messages.log), generates structure.json, and saves the result in the GIS_Viewer folder

To run a simulation use `./run_simulation <area flag>` where `<area_flag>` is **either** `--Ontario` or `--Ottawa` (ex: `./run_simulation --Ontario`). Once it finishes a link to the visualizer will be displayed in the terminal and all the required files to view the simulation will be located at the path displayed in the terminal.

*Tip: Use the `--flags` flag to see all the options for more power configurations*

---

Compiling the Program
----
**Using CMAKE**
1. Navigate to the root directory of the copy of this project
2. Enter the following command: `cmake CMakeLists.txt`
3. Execute the make file using the command: `make`

Generating a scenario from geographical data
----
A scenario.json is generated by running generate_ontario_phu_json.py or generate_ottawa_da_json.py

1. Open a terminal and navigate to `/Geography-Based-Model/Scripts/Input_Generator`
2. Edit scenario inputs in the script's input folder folder (`default.json`, `fields.json`, `infectedCell.json`) as desired
3. Enter the following command `python generate_ontario_phu_json.py` or  `python generate_ottawa_da_json.py`

Running a Model
----

To run the model:
1. Create a directory called logs in the root directory of this project (if one does not already exist)
2. Go to the bin folder from the root directory
3. Enter the following command:

`./pandemic-geographical_model <configuration_file_path>/scenario.json [<simulation time>]`

The last parameter is optional. The default is 500.

Viewing Results in GIS Web Viewer V2
---
The most recent version of the GIS Web Viewer can be found at http://206.12.94.204:8080/arslab-web/1.3/app-gis-v2/index.html

Upload a simulation's geojson, messages.log, structure.json, visualization.json to view simulation results. See [GIS_Viewer folder README](https://github.com/SimulationEverywhere-Models/Geography-Based-SEIRDS-Vaccinated/tree/master/GIS_Viewer) for more details

Downloading geopandas
---
This project uses several python scripts that are dependent on the libraries: geopandas, numpy, and matplotlib. geopandas requires specific versions of many dependent libraries and installing them manually is difficult. The easiest way to download the right packages is to use conda. It is also recommended to install these packages in a seperate conda environment. Attemping to install in conda base may fail.
1. https://www.anaconda.com/products/individual
2. select 64-Bit (x86) Installer (Linux)
3. run the .sh installer, recommended default settings
4. open a terminal and activate conda if not already active
5.
~~~ 
conda create --name geo_env
conda activate geo_env
conda install geopandas numpy matplotlib
~~~

Configuring VSCode
---
As the project references files in the Cadmium directory it's nice to let VSCode know where they are so it doesn't throw a bunch of errors (note: the code still compiles fine regardless because the makefiles are set to be aware of Cadmium's location, provided it's saved in the correct spot. 
* You'll need the C++ extension provided by Microsoft
* In the Explorer pane add `.vscode` as a new folder if it doesn't already exist
* In this folder add `c_cpp_properties.json`
* In the file paste the following ***if you are using Linux***
~~~
{
  "configurations": [
    {
      "name": "GCC",
      "includePath": [
      "~/Documents/cadmium/**"
      ],
      "compilerPath": "/usr/bin/gcc",
      "cStandard": "gnu17",
      "cppStandard": "gnu++14",
      "intelliSenseMode": "gcc-x64"
    }
  ],
  "version": 4
}
~~~
For those not on Linux you'll have to do a bit of digging online for what to set the other parameter but the important one is `includePath`. That's where you set where cadmium is located and don't forget the `**` at the end as that tells VS to search all the subdirectories. This should remove errors shown in the problems pane at the bottom such as "_could not located this header file_".
